<!DOCTYPE html>
<html lang="ar">
  <head>
    <meta charset="UTF-8" />
    <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø±ØªØ¨Ø§Øª</title>

    <style>
      body {
        font-family: Cairo;
        background: #f0f8ff;
        direction: rtl;
        padding: 20px;
      }

      .box {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        max-width: 1100px;
        margin: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }

      th,
      td {
        border: 1px solid #aaa;
        padding: 8px;
        text-align: center;
      }

      th {
        background: #008cff;
        color: #fff;
      }

      button {
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        color: #fff;
        cursor: pointer;
        margin: 5px;
      }

      .del {
        background: red;
      }
      .pay {
        background: green;
      }
      #printPdf {
        background: #ff8c00;
      }

      input {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border-radius: 8px;
        border: 1px solid #aaa;
      }

      /* ===== Footer ===== */
      footer {
        background: #008cff;
        color: #fff;
        text-align: center;
        padding: 12px;
        border-radius: 10px;
        margin-top: 20px;
        font-size: 14px;
      }
      footer a {
        color: #fff;
        text-decoration: none;
      }
      footer a:hover {
        color: peru;
      }

      /* ===== Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© ===== */
      #backBtn {
        background: #00bfff;
        color: #fff;
        font-weight: bold;
        font-size: 16px;
        padding: 10px 20px;
        margin-top: 15px;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      #backBtn:hover {
        background: #008cff;
        transform: scale(1.05);
      }
    </style>
  </head>

  <body>
    <div class="box" id="reportContent">
      <h2>ğŸ“„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø±ØªØ¨Ø§Øª</h2>
      <p
        id="currentTime"
        style="text-align: center; color: #555; margin-bottom: 10px"
      ></p>

      <input id="search" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…" />

      <h3>âš ï¸ Ù„Ø¯ÙŠÙ‡Ù… Ù…ØªØ¨Ù‚ÙŠ</h3>
      <table id="remain"></table>

      <h3>âœ… ØªÙ… Ø§Ù„Ø¯ÙØ¹ ÙƒØ§Ù…Ù„</h3>
      <table id="full"></table>

      <h3>ğŸ’° Ø£Ø®Ø°ÙˆØ§ Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ù…Ø±ØªØ¨</h3>
      <table id="over"></table>

      <div style="margin-top: 10px">
        <button id="backBtn" onclick="location.href='index.html'">
          â¬… Ø¹ÙˆØ¯Ø©
        </button>
        <button id="printPdf">ØªÙ†Ø²ÙŠÙ„ PDF</button>
        <button onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF</button>
      </div>
    </div>

    <footer>
      &copy;2025 <a href="">Eyad Abdallah</a> | All rights reserved
    </footer>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <!-- jsPDF & html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
      var firebaseConfig = {
        apiKey: "AIzaSyAu9HDit-G8JllC-wcTmvXx7vchWmNs9ms",
        authDomain: "ali-eisesy.firebaseapp.com",
        databaseURL: "https://ali-eisesy-default-rtdb.firebaseio.com",
        projectId: "ali-eisesy",
        storageBucket: "ali-eisesy.appspot.com",
        messagingSenderId: "31241139042",
        appId: "1:31241139042:web:66b06edcded73616c8f23b",
      };
      firebase.initializeApp(firebaseConfig);
      var db = firebase.database();

      let data = [];
      let keys = [];

      db.ref("workers").on("value", (snap) => {
        data = [];
        keys = [];
        snap.forEach((c) => {
          data.push(c.val());
          keys.push(c.key);
        });
        render();
      });

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
      function updateTime() {
        let now = new Date();
        let options = {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        };
        document.getElementById("currentTime").innerText =
          now.toLocaleDateString("ar-EG", options);
      }
      updateTime();
      setInterval(updateTime, 1000);

      function render() {
        let s = search.value.toLowerCase();

        remain.innerHTML =
          "<tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø±ØªØ¨</th><th>Ø§Ù„Ù…Ø³ØªÙ„Ù…</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>";
        full.innerHTML =
          "<tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø±ØªØ¨</th><th>Ø§Ù„Ù…Ø³ØªÙ„Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>";
        over.innerHTML =
          "<tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø±ØªØ¨</th><th>Ø§Ù„Ù…Ø³ØªÙ„Ù…</th><th>Ø§Ù„Ø²ÙŠØ§Ø¯Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>";

        data.forEach((d, i) => {
          if (s && !d.name.toLowerCase().includes(s)) return;

          if (d.received > d.salary) {
            over.innerHTML += `
      <tr>
        <td>${d.name}</td>
        <td>${d.salary}</td>
        <td>${d.received}</td>
        <td>${d.received - d.salary}</td>
        <td>${d.date}</td>
        <td>
          <button class="del" onclick="del('${keys[i]}')">Ù…Ø³Ø­</button>
        </td>
      </tr>`;
          } else if (d.remaining > 0) {
            remain.innerHTML += `
      <tr>
        <td>${d.name}</td>
        <td>${d.salary}</td>
        <td>${d.received}</td>
        <td>${d.remaining}</td>
        <td>${d.date}</td>
        <td>
          <button class="pay" onclick="payMore('${keys[i]}',${d.remaining})">Ø¯ÙØ¹ Ø§Ù„Ø¨Ø§Ù‚ÙŠ</button>
          <button class="del" onclick="del('${keys[i]}')">Ù…Ø³Ø­</button>
        </td>
      </tr>`;
          } else {
            full.innerHTML += `
      <tr>
        <td>${d.name}</td>
        <td>${d.salary}</td>
        <td>${d.received}</td>
        <td>${d.date}</td>
        <td>
          <button class="del" onclick="del('${keys[i]}')">Ù…Ø³Ø­</button>
        </td>
      </tr>`;
          }
        });
      }

      function del(key) {
        if (confirm("Ù…Ø³Ø­ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ")) {
          db.ref("workers/" + key).remove();
        }
      }

      function payMore(key) {
        let add = Number(prompt("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ"));
        if (add <= 0) return;
        db.ref("workers/" + key).once("value", (snap) => {
          let d = snap.val();
          d.received += add;
          d.remaining = d.salary - d.received;
          if (d.remaining < 0) d.remaining = 0;
          d.date = new Date().toLocaleString(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹
          db.ref("workers/" + key).set(d);
        });
      }

      search.addEventListener("input", render);

      // ===== ØªÙ†Ø²ÙŠÙ„PDF =====
      document.getElementById("printPdf").addEventListener("click", () => {
        const report = document.getElementById("reportContent");
        html2canvas(report).then((canvas) => {
          const imgData = canvas.toDataURL("image/png");
          const pdf = new jspdf.jsPDF("p", "mm", "a4");
          const imgProps = pdf.getImageProperties(imgData);
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
          pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
          pdf.save("ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù…Ø±ØªØ¨Ø§Øª.pdf");
        });
      });
    </script>
  </body>
</html>
